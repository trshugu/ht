<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html" charset="utf-8">
    <title>tmp</title>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="tmp.js"></script>
    <link href="tmp.css" rel="stylesheet">
    <script src="https://cdn.rawgit.com/jashkenas/coffeescript/571e9df3/docs/v2/browser-compiler/coffeescript.js"></script>
    <style type="text/css">
      marquee{font-weight: bold;}
      .ni{position: absolute}
      
      #fff{position:fixed; top:10px; left:10px}
      
    </style>
    <script type="text/javascript"></script>
    <script type="text/coffeescript">
      console.log "OK"
      
      ids = []
      tws = []
      setInterval ->
        console.log "gettw", ids.length
        # fetch "http://.com/gettw/" + "%E3%82%A6%E3%82%B5%E3%82%AE"
        fetch "http://.com/gettw/" + "紅白司会"
        .then (v)->
          # console.log "done", v
          v.json().then (list)->
            list.forEach (i)->
              if (ids.some (j)-> j == i._id)
                # あった
                # console.log "atta"
              else
                # なかった
                # console.log "nakatta"
                ids.push i._id
                tws.push i.value
            
            while tws.length > 0
              console.log tws
              aQueue.push tws.shift()
        .catch (e)-> console.log "e", e
      , 2000
      
      
      # 全体の設定
      b0 = document.getElementsByTagName('body')[0]
      nArea = document.createElement("div")
      mArea = document.createElement("div")
      mArea.className = "ni"
      nArea.appendChild mArea
      b0.parentNode.insertBefore(nArea, b0)
      
      ncom = (com)->
        return if com == ""
        
        mNew = document.createElement("marquee")
        sNew = document.createElement("span")
        sNew.innerText = com
        mNew.appendChild sNew
        
        lane = (nArea.childElementCount-1) * 24
        mArea.parentNode.insertBefore(mNew, mArea)
        
        mNew.loop = "1"
        mNew.scrollDelay = "4000"
        mNew.scrollAmount = b0.offsetWidth + sNew.offsetWidth
        mNew.style = "position:fixed; top:" + lane + "px"
        
        ntext.value = ""
        
        setTimeout ->
          mNew.remove()
        , 4300
      
      
      
      # データがあったら流す
      aQueue = []
      poller = ->
        if aQueue.length != 0
          ncom aQueue.shift()
          
          setTimeout ->
            poller()
          , 100
        else
          setTimeout ->
            poller()
          , 2000
      
      poller()
      
      # aQueueに送る関数
      sender = ()->
        return if ntext.value == ""
        aQueue.push ntext.value
        ntext.value = ""
      
      # viewから
      nbutton.addEventListener  "click", sender
      ntext.addEventListener  "keypress", (e)->
        key = e.which || e.keyCode
        sender() if key == 13
      
      
      
      
    </script>
  </head>
  <body>
    <div id="tmp" onClick="add()">tmp</div>
    <div id="fff">
      <input type="text" id="ntext">
      <button id="nbutton">コメント</button>
    </div>
    <canvas id="pjs"></canvas>
    <!-- script(type="text/javascript", src="coffeescript.js")-->
  </body>
</html>